{# templates/home/member_home.html.twig #}
{% extends 'base.html.twig' %}

{% block body %}
    <link href="{{ asset('styles/home.css') }}" rel="stylesheet">
    <section class="user-home main-content">
        {% if app.user %}
            <h2>Bienvenue {{ app.user.name }}</h2>
        {% else %}
            <h2>Bienvenue, veuillez vous connecter pour accéder aux fonctionnalités.</h2>
        {% endif %}
        <p>Voici les activités disponibles pour vous :</p>
        </br></br>

        <section class="activities form-container">
            {% if activities is defined and activities|length > 0 %}
                <h2>Activités disponibles</h2>
                <table class="activities-table" id="activities-table">
                    <thead>
                        <tr>
                            <th><button type="button" class="sort-button styled-header btn" data-sort="name">Nom</button></th>
                            <th><button type="button" class="sort-button styled-header btn" data-sort="date">Date</button></th>
                            <th><button type="button" class="sort-button styled-header btn" data-sort="difficulty">Niveau de Difficulté ⭐</button></th>
                            <th>Horaires</th>
                            <th>Sélectionner</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for activity in activities %}
                            <tr>
                                <td>{{ activity.activity_name }}</td>
                                <td>{{ activity.session_date|date('d-m-Y') }}</td>
                                <td>{{ activity.level_label }}</td>
                                <td>{{ activity.session_time|date('H:i') }} - {{ activity.session_duration|date('H:i') }}</td>
                                <td>
                                    {% if app.user %}
                                        {% if activity.is_registered %}
                                            <button type="button" class="unregister-button btn" data-activity-name="{{ activity.activity_name }}" data-activity-time="{{ activity.session_time|date('H:i') }} - {{ activity.session_duration|date('H:i') }}" data-activity-date="{{ activity.session_date|date('d-m-Y') }}">Se désinscrire</button>
                                        {% else %}
                                            <button type="button" class="register-button btn" data-activity-name="{{ activity.activity_name }}" data-activity-time="{{ activity.session_time|date('H:i') }} - {{ activity.session_duration|date('H:i') }}" data-activity-date="{{ activity.session_date|date('d-m-Y') }}">S'inscrire</button>
                                        {% endif %}
                                    {% else %}
                                        <button type="button" class="register-button btn" disabled>S'inscrire</button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5">Aucune activité disponible pour le moment.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Aucune activité disponible pour le moment.</p>
            {% endif %}
            </br></br>
        </section>
    </section>

    <!-- Popup pour afficher les informations transmises -->
    <div id="popup" class="popup hidden">
        <div class="popup-content form-container">
            <span class="close-popup btn-back">&times;</span>
            <h2>Informations transmises :</h2>
            <pre id="info-content">Aucune sélection pour le moment.</pre>
        </div>
    </div>

    <script>
    document.querySelectorAll('.register-button, .unregister-button').forEach(button => {
        button.addEventListener('click', function () {
            const activityName = this.getAttribute('data-activity-name');
            const activityTime = this.getAttribute('data-activity-time');
            const activityDate = this.getAttribute('data-activity-date');
            const userName = '{{ app.user ? app.user.name : '' }}';
            const url = this.classList.contains('register-button') ? '/reserve' : '/unreserve';

            // Mise à jour de la boîte d'informations
            const infoContent = document.getElementById('info-content');
            infoContent.textContent = `${activityName}: ${activityTime} le ${activityDate}`;

            // Afficher la popup
            const popup = document.getElementById('popup');
            popup.classList.add('active');

            // Envoyer les données via AJAX
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    name: activityName,
                    date: activityTime,
                    user_name: userName,
                    reservation_date: activityDate
                })
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                // Recharger la page pour mettre à jour les boutons
                location.reload();
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        });
    });

    // Fermer la popup
    document.querySelector('.close-popup').addEventListener('click', function () {
        const popup = document.getElementById('popup');
        popup.classList.remove('active');
    });

    // Tri du tableau
    document.querySelectorAll('.sort-button').forEach(button => {
        button.addEventListener('click', function () {
            const table = document.getElementById('activities-table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const sortType = this.dataset.sort;

            rows.sort((a, b) => {
                let valA, valB;

                if (sortType === 'name') {
                    valA = a.cells[0].textContent.trim().toLowerCase();
                    valB = b.cells[0].textContent.trim().toLowerCase();
                    return valA.localeCompare(valB);
                } else if (sortType === 'date') {
                    valA = new Date(a.cells[1].textContent.trim());
                    valB = new Date(b.cells[1].textContent.trim());
                    return valB - valA; // Tri par date descendante
                } else if (sortType === 'difficulty') {
                    valA = a.cells[2].textContent.trim().length; // Compte les étoiles
                    valB = b.cells[2].textContent.trim().length;
                    return valB - valA; // Tri par difficulté descendante
                }
            });

            // Réorganiser les lignes dans le tableau
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        });
    });
    </script>
{% endblock %}